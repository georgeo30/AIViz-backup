<!DOCTYPE html>
<meta charset="utf-8">
<!-- <script src="jquery-2.1.4.js"></script>
<script src="/js/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<title>Africa Internet Visualizer</title>

<!--Styling of elements on map-->
<style>
  html,
  body {

    position: fixed;
  }

  .spinner {
    display: flex;
    justify-content: space-between;
  }

  .country-area {
    fill: rgb(204, 204, 204, 0.9);
    stroke: black;
  }

  /*.countries*/
  .country-area:hover {
    fill: rgba(240, 240, 240, 0.8);
    ;
  }

  .c2p {
    stroke: rgb(93, 93, 250);
    stroke-opacity: 0.5;
    stroke-width: 0.1;

    fill: none;
  }

  .same-customer {
    stroke: green;
    fill: none;
  }

  .p2p {
    stroke: rgb(78, 255, 78);
    stroke-opacity: 0.5;
    stroke-width: 0.1;
    fill: none;
  }

  .same-peer {
    stroke: red;
    fill: none;
  }

  .s2s {
    stroke: rgb(255, 67, 67);
    stroke-opacity: 1;
    stroke-width: 0.25;

    fill: none;
  }

  .same-sibling {
    stroke: turquoise;
    fill: none;
  }

  .asn:hover {
    stroke: rgb(84, 84, 236);
  }

  .IXP {

    fill: rgb(255, 255, 255, 0.1);
    stroke: rgba(29, 28, 28, 0.9);
    stroke-width: 1
  }

  .asn-dot {
    fill: rgb(255, 255, 255, 0.3);
    stroke: rgba(29, 28, 28, 0.8);

    stroke-width: 0.5;
  }

  body,
  html {
    height: 100%;
  }

  body {
    background-color: #242F3F;
  }

  .loader {
    display: inline-block;
    width: 30px;
    height: 30px;
    position: relative;
    border: 4px solid #Fff;
    animation: loader 2s infinite ease;
  }

  .loader-inner {
    vertical-align: top;
    display: inline-block;
    width: 100%;
    background-color: #fff;
    animation: loader-inner 2s infinite ease-in;
  }

  .loader-wrapper {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    /* background-color:black; */
  }

  @keyframes loader {
    0% {
      transform: rotate(0deg);
    }

    25% {
      transform: rotate(180deg);
    }

    50% {
      transform: rotate(180deg);
    }

    75% {
      transform: rotate(360deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes loader-inner {
    0% {
      height: 0%;
    }

    25% {
      height: 0%;
    }

    50% {
      height: 100%;
    }

    75% {
      height: 100%;
    }

    100% {
      height: 0%;
    }
  }
</style>
<!--hamburger Menu, filters and map-->

<body style="background-color: 	rgba(83, 83, 83, 0.6);">
  <div class="loader-wrapper">
    <span class="loader"><span class="loader-inner"></span></span>
  </div>
  <div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left" style="display:none; background-color: white;"
    id="mySidebar">
    <!-- Header and Menu button -->
    <div style="background-color: black; color:white;">
      <button class="w3-button w3-xlarge w3-hover-black w3-bar-item" onclick=" w3_close()">&times;
        <h3 style=" display: inline-block; ">Africa Internet Visualizer</h3></button>
    </div>
    <!-- Border checkbox -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="cbborder" name="vehicle1" checked="checked"> <label
          for="vehicle1">Borders</label><br>

        </label></input>
      </div>
    </a>

    <div style="margin-left: 15px;">
      <text class="">Selected year </text>

    <select id="selectNumber">
      <!-- <option value="" disabled selected>Select your option</option> -->
  </select>
</div>

    <!-- Different Views options -->
    <a class="w3-bar-item">Views</a>

    <!-- Continental View checkbox -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="allixpsandasns" onclick="continentalView()" checked="checked">
        <label>Continental View
        </label><br>

        </label></input>
      </div>

    </a>
    <!-- <div class="w3-dropdown-hover">
      <button class="w3-button dropDownLevels">Select ASN Level <i class="fa fa-caret-down"></i><span id="levelhtml">
          Level 1 </span></button>
      <div class="w3-dropdown-content w3-bar-block">
        <a href="#" class="w3-bar-item w3-button level" id="1" onclick="levelClick(event)">Level 1</a>
        <a href="#" class="w3-bar-item w3-button level" id="2" onclick="levelClick(event)">Level 2</a>
        <a href="#" class="w3-bar-item w3-button level" id="3" onclick="levelClick(event)">Level 3</a>
        <a href="#" class="w3-bar-item w3-button level" id="4" onclick="levelClick(event)">Level 4</a>
        <a href="#" class="w3-bar-item w3-button level" id="5" onclick="levelClick(event)">Level 5</a>
        <a href="#" class="w3-bar-item w3-button level" id="6" onclick="levelClick(event)">Level 6</a>



      </div>
    </div> -->
    <div id="radiobuttons">
      <a class="w3-bar-item">Show Top:</a>

      <div class="spinner">
        <p style="margin-top: 0px;"> &nbsp;
          <input class="w3-radio" id="radioone" type="radio" value="25%" name="cones" onclick="conesLevel(1)" checked>
          <label>25%</label></p>
        <p style="margin-top: 0px;">
          <input class="w3-radio" id="2" type="radio" value="50%" name="cones" onclick="conesLevel(2)">
          <label>50%</label></p>
        <p style="margin-top: 0px;">
          <input class="w3-radio" id="3" type="radio" value="75%" name="cones" onclick="conesLevel(3)">
          <label>75%</label></p>
        <p style="margin-top: 0px;">
          <input class="w3-radio" id="radiofour" type="radio" value="100%" name="cones" onclick="conesLevel(4)">
          <label>100% </label>&nbsp;</p>
      </div>
    </div>
    <div id="ixplevelcontrol">
      <a class="w3-bar-item">Choose ASN Level</a>






      <div class="spinner" style="background-color: rgba(240, 240, 240, 0.8);color: black;">
        <button style="background-color: grey;color: white;" id="decrease" onclick="decreaseLevel()" disabled><i
            class="fas fa-minus"></i></button>
        <p id="levelsText">1</p>
        <button id="increase" style="background-color: black;color: white;" onclick="increaseLevel()"><i
            class="fas fa-plus"></i></button>
      </div>
    </div>
    <!-- Relationship Views Options -->
    <a class="w3-bar-item">Relationships</a>

    <!-- Peer to peer cb -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="p2pcb" onclick="peerToPeer()" unchecked> <label>Peer to Peer
        </label><br>

        </label></input>
      </div>

    </a>
    <!-- customer to provider relationship -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="c2pcb" onclick="customerToProvider()" unchecked> <label>Customer to
          provider
        </label><br>

        </label></input>
      </div>

    </a>
    <!-- sibling to sibling relationship -->

    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="s2scb" onclick="siblingToSibling()" unchecked> <label>Sibling to Sibling
        </label><br>

        </label></input>
      </div>

    </a>


    <div class="w3-panel w3-leftbar w3-rightbar" style="background-color: rgba(240, 240, 240, 0.8); color: black;">
      <p id="cCodeHTML">Hover over an ASN, IXP or country to see details</p>
      <p id="noOfIXPsHTML"></p>
      <p id="noOfASNsHTML"></p>
      <p id="ixpIdHTML"></p>
      <p id="ixpNameHTML"></p>
      <p id="ixpCountryHTML"></p>
      <p id="ixpCustomersHTML"></p>
      <p id="asnIdHTML"></p>
      <p id="asnCountryHTML"></p>
      <p id="asnCustomersHTML"></p>
    </div>
    <!-- <div class="w3-panel w3-pale-yellow w3-leftbar w3-rightbar w3-border-yellow">
      <p id="ixpIdHTML">IXP ID : </p>
      <p id="ixpNameHTML">IXP Name : </p>
      <p id="ixpCountryHTML">Country: </p>
      <p id="ixpCustomersHTML">Direct Customers: </p>
    </div>
    <div class="w3-panel w3-pale-green w3-leftbar w3-rightbar w3-border-green w3-border">
      <p id="asnIdHTML">ASNS ID : </p>
      <p id="asnCountryHTML">Country : </p>
      <p id="asnCustomersHTML">Connections: </p>
    </div> -->








    <!-- Header and Menu button -->

  </div>
  <div id="headerheading" style="background-color: black; width:100%;">
    <button id="openNav" class="w3-button w3-xlarge w3-hover-black w3-bar-item"
      style="background-color: black; color: white;" onclick="w3_open()">&#9776; <h2 style=" display: inline-block;">
        Africa Internet Visualizer</h1>
    </button>

  </div>
  <div id="main">
    <span>
      <button id="zoom-in"><i class="fas fa-search-plus"></i></button>
      <button id="zoom-out"><i class="fas fa-search-minus"></i></button>
      <button id="centre"><i class="fas fa-redo-alt"></i></button>
    </span>



    <script>
      //Organizing Side Navigation bar
      function w3_open() {
        document.getElementById("main").style.marginLeft = "25%";
        document.getElementById("mySidebar").style.width = "25%";
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("openNav").style.display = 'none';
      }
      function w3_close() {
        document.getElementById("main").style.marginLeft = "0%";
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("openNav").style.display = "inline-block";
      }

      //Border color method
      document.getElementById("cbborder").onclick = function () {
        if (this.checked) {
          let cols = document.getElementsByClassName(/*'countries'*/'country-area');

          for (i = 0; i < cols.length; i++) {
            cols[i].style.stroke = 'black';

          }


        }
        else {
          let cols = document.getElementsByClassName(/*'countries'*/'country-area');
          for (i = 0; i < cols.length; i++) {
            cols[i].style.stroke = 'rgb(204,204,204,0.9)';

          }

        }
      };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://kit.fontawesome.com/a68d1a8f9d.js" crossorigin="anonymous"></script>

    <!--D3 work starts here-->
    <script>

      //Canvas settings
      const width = window.innerWidth, height = window.innerHeight;
      var centered;

      const OVERLAY_MULTIPLIER = 10;
      const OVERLAY_OFFSET = OVERLAY_MULTIPLIER / 2 - 0.5;
      const ZOOM_DURATION = 500;
      const ZOOM_IN_STEP = 2;
      const ZOOM_OUT_STEP = 1 / ZOOM_IN_STEP;
      const ZOOM_COUNTRY_CLICK = 4;
      const ZOOM_THRESHOLD = [1, 13];
      //var x,y,k=1;
      var x = width / 2, y = height / 2, k = 1;
      //Projection type
      var projection = d3.geoMercator()
        .translate([width / 2.5, height / 2.25])
        .scale(600);

      //Path generator
      var path = d3.geoPath()
        .projection(projection);

      //ZOOM
      const zoom = d3.zoom().scaleExtent(ZOOM_THRESHOLD)
        .on("zoom", zoomed);


      //ASN projection
      var pathTwo = d3.geoPath()
        .projection(projection)
        .pointRadius(5);

      //Add canvas with settings for its height and width, store the reference here in svg
      var svg = d3.select("#main").append("svg")
        .attr("width", width)
        .attr("height", height);

      var g = svg.call(zoom).append("g");
      //g.call(zoom).on("wheel.zoom", null);;

      //Adding a rectangle for better zoom and pan

      g.append("rect")
        .attr("width", width * OVERLAY_MULTIPLIER)
        .attr("height", height * OVERLAY_MULTIPLIER)
        .attr(
          "transform",
          `translate(-${width * OVERLAY_OFFSET},-${height * OVERLAY_OFFSET})`
        )
        .style("fill", "none")
        .style("pointer-events", "all");

      d3.select("#zoom-in").on("click", function () {
        //k = k + 0.5;
        clickToZoom(ZOOM_IN_STEP);
      });
      d3.select('#zoom-out').on('click', function () {
        //k = k - 0.5;
        clickToZoom(ZOOM_OUT_STEP);
      });
      d3.select('#centre').on('click', function () {
        reset()
      });

      //Methods used to know what filtering methods must be applied
      var currentView = "continental";

      var previousCountry;

      //var clickedIxp;

      var previousIXP;

      var customerAsns;

      var countryAsns = [];

      var ixpsbyid;

      var asnsbyid;

      var level = 1;

      var asnViewMap;

      var levelsMap;

      var previousLevel;

      var p2pCheckBox = document.getElementById("p2pcb");

      var c2pCheckBox = document.getElementById("c2pcb");

      var s2sCheckBox = document.getElementById("s2scb");

      var colorScheme = { "1": "#ff47f3", "2": "#ff7cb2", "3": "#ffb26f", "4": "#ffe72e" };

      //TESTING API CALL

      // async function getUsers(file){
      //   let response =await fetch('http://127.0.0.1:5000/file/'+file);
      //   let data =await response.json()
      //   return data;
      // }
      //getUsers("csvjson.json").then(data=>console.log(data));
      var ixpsAPI;
      // getUsers("csvjsonIXP.json").then(data=>ixpsAPI=data);
      var asnsAPI;
      // getUsers("csvjson.json").then(data=>asnsAPI=data);
      //console.log(asnsAPI);


      // asnsAPI=d3.request("http://127.0.0.1:5000/file/csvjson.json").mimeType("application/json").response(function(lmao){
      //   return JSON.parse(lmao.responseText);
      // })
      var dateList;

      d3.queue().defer(d3.json, "http://127.0.0.1:5000/dates").await(readyList);
      function readyList(error, dates) {
        dateList = dates;
        latest=dateList["dates"][0]
        d3.queue()
        .defer(d3.json, "africaTopo.json")
        //.defer(d3.csv, "IXPsRealALT.csv", typeIxp)
        .defer(d3.json, "http://127.0.0.1:5000/ixp/" + latest + ".json")

        // .defer(d3.csv, "./ASNsRealALT.csv", typeAsn)
        .defer(d3.json, "http://127.0.0.1:5000/asn/" + latest + ".json")

        .await(ready);
      }
      //console.log(dateList);

      //console.log(asnsAPI);
      // Load data... Should we split this up into callable methods?
      // d3.queue()
      //   .defer(d3.json, "africaTopo.json")
      //   //.defer(d3.csv, "IXPsRealALT.csv", typeIxp)
      //   .defer(d3.json, "http://127.0.0.1:5000/ixp/" + date + ".json")

      //   // .defer(d3.csv, "./ASNsRealALT.csv", typeAsn)
      //   .defer(d3.json, "http://127.0.0.1:5000/asn/" + date + ".json")

      //   .await(ready);

      // Load data: Alternative
      // d3.queue()
      //   .defer(d3.json, "http://192.168.0.18:8080/testTopoAfrica.json")
      //   .defer(d3.csv, "http://192.168.0.18:8080/ixps.csv", typeIxp)
      //   .defer(d3.csv, "http://192.168.0.18:8080/asnTestTwo.csv", typeAsn)
      //   .defer(d3.csv, "http://192.168.0.18:8080/links.csv")
      //   .await(ready);


      //Callback after data is loaded
      function ready(error, africa, ixps, asns) {
        ixps = typeIxp(ixps);
        asns = typeAsn(asns);
        // ixps = typeIxp(ixpsAPI);
        // asns = typeAsn(asnsAPI);
        if (error) throw error;

        //Set id fields as the key for the ixp and asn datasets
        ixpsbyid = d3.map(ixps, function (d) { return d.id; });
        asnsbyid = d3.map(asns, function (d) { return d.id; });


        //Convert each country from the topology file to a geoJson feature
        var features = topojson.feature(africa, africa.objects.edit).features;



        //Draw countries inside the drawing box using the geoJson features
        drawCountryBorders(features);

        //Add empty country-containers that will contain asn and ixp elements
        var countries = g.selectAll(".country") //null is used since no country containers have been defined before (no search time -> more efficient )
          .data(features)
          .enter().append("g")
          .attr("class", "country")
          .style("visibility", "visible")
          .attr("id", function (currentFeature) { return currentFeature.properties.country_code });


        //Draw all ASNS
        drawASNS(asns);

        //Draw all IXPS
        drawIXPS(ixps);

        currentView = "continental";
        let viewStatus = document.getElementById("allixpsandasns").checked;
        document.getElementById("ixplevelcontrol").style.display = "none";

        d3.select(".loader-wrapper").remove();
        // document.getElementById("radiobuttons").style.display="initial";

        // continentalView();
        dropdown();
      } //end of reading files

      //For big ASN file, intiall lode causes relationship button to not work until a differnet view is selected first.
      //So we just load continentalView again to ensure relationship cb will work on inital load

      function drawCountryBorders(features) {
        //Add drawing-box that will contain all country drawings (outlines of a country & an onclick method)
        let drawingBox = g.append("g").attr("class", "drawing-box");

        drawingBox.selectAll(null) //null is used since no country-area element has been created before
          .data(features)
          .enter()
          .append("path")
          .attr("class", "country-area")
          .attr("d", path)
          .on("click", clickCountry)
          .on("mouseover", hoverCountry);
      }


      function drawIXPS(ixps) {
        g.selectAll("IXP").data(ixps).enter().each(function (currentIxp, i) {
          let currentCountry = g.select(`#${currentIxp.country}.country`);
          currentCountry.append("polygon").datum(currentIxp).attr("points", function () {
            let len = 8;
            let cons = (Math.sqrt(3)) / 2;
            let centerX = projection([currentIxp.longitude, currentIxp.latitude])[0];
            let centerY = projection([currentIxp.longitude, currentIxp.latitude])[1];
            return `${centerX - (len * cons)},${centerY + (len / 2)} ${centerX},${centerY - len} ${centerX + (len * cons)},${centerY + (len / 2)}`;
          }).attr("class", "IXP")
            .style("visibility", "inherit")
            .attr("id", function () { return `IXP_${currentIxp.id}` })
            .on("click", clickIxp)
            .on("mouseover", hoverIXP);


        });
      }


      function drawASNS(asns) {

        g.selectAll(null).data(asns).enter().each(function (sourceAsn) {

          let currentCountry = g.select(`#${sourceAsn.country}.country`);
          currentCountry.append("g").datum(sourceAsn)
            .attr("class", "ASN").style("visibility", function (d) {
              return (d.AfricaLevel <= level) ? "inherit" : "hidden";

            }).attr("id", function (d) { return sourceAsn.id })
            .each(function (d, i) {

              let currentContainer = d3.select(this); //g element 

              let countryC2pStatus = c2pStatus() ? "inherit" : "hidden";
              let countryP2pStatus = p2pStatus() ? "inherit" : "hidden";
              let countryS2sStatus = s2sStatus() ? "inherit" : "hidden";

              let p2pGroup = currentContainer.append("g").attr("class", "p2p").style("visibility", countryP2pStatus);

              let c2pGroup = currentContainer.append("g").attr("class", "c2p").style("visibility", countryC2pStatus);

              let s2sGroup = currentContainer.append("g").attr("class", "s2s").style("visibility", countryS2sStatus);

              let values = "";



              sourceAsn.map.forEach(function (relationshipType, destinationKey, map) { //loop through every key-value pair

                let destinationAsn = asnsbyid.get(destinationKey);
                // currentRelationship = { type: "LineString", coordinates: [sourceAsn, destinationAsn] };

                currentContainer.select(`g.${relationshipType}`)
                  .append("line")
                  //.attr("d", path(currentRelationship))
                  .attr("x1", function () { return projection([sourceAsn.longitude, sourceAsn.latitude])[0] })
                  .attr("x2", function () { return projection([destinationAsn.longitude, destinationAsn.latitude])[0] })
                  .attr("y1", function () { return projection([sourceAsn.longitude, sourceAsn.latitude])[1] })
                  .attr("y2", function () { return projection([destinationAsn.longitude, destinationAsn.latitude])[1] })
                  .style("visibility", function () {
                    if (destinationAsn.CountryLevel > sourceAsn.CountryLevel) {
                      return "hidden";
                    }
                    //Destination in same layer requires to check if destination has been processed before
                    else if (destinationAsn.CountryLevel == sourceAsn.CountryLevel) {
                      return destinationAsn.processed ? "hidden" : "inherit";
                    }
                    //Destination in layer above must be drawn
                    else {
                      return "inherit";
                    }
                  })

                  .attr("class", relationshipType)
                  .attr("destination", destinationAsn.id);
              })


              currentContainer.append("circle")
                .attr("class", function (d) { return `asn-dot` })
                .attr("cx", function (d) { return projection([sourceAsn.longitude, sourceAsn.latitude])[0] })
                .attr("cy", function (d) { return projection([sourceAsn.longitude, sourceAsn.latitude])[1] })
                //.style("fill", "rgb(255,255,0,0.7)")
                .style("visibility", "inherit")
                .style("fill", continentalFill)
                .style("stroke", continentalFill)
                .style("fill-opacity", 0.25)


                //             fill: rgb(255, 255, 255, 0.3);
                // stroke: rgba(29, 28, 28, 0.8);
                .attr("r", 1.5)
                .on("mouseover", hoverASN);

            });

        });
      }

      function continentalFill(d) {
        return colorScheme[d.AfricaLevel];


      }

      function countryFill(d) {
        return colorScheme[d.CountryLevel];

      }

      // All IXPs and ASNs checkbox
      function continentalView() {
        document.getElementById("ixplevelcontrol").style.display = "none";
        document.getElementById("radiobuttons").style.display = "initial";


        resetLevel();

        reset();

        revertPreviousView();

        currentView = "continental";

        let viewStatus = document.getElementById("allixpsandasns").checked;

        drawEverything(viewStatus);

      }







      // Check box for Peer to peer
      //Triggers a call to disable/enable all peer-peer relationships
      function peerToPeer() {
        let visibilityStatus = p2pStatus();
        setType("p2p", visibilityStatus);
      }

      // Check box for Customer to provider
      //Triggers a call to disable/enable all customer-provider relationships
      function customerToProvider() {
        let visibilityStatus = c2pStatus();
        setType("c2p", visibilityStatus);
      }
      // Check box for sibling to sibling
      //Triggers a call to disable/enable all sibling-sibling relationships
      function siblingToSibling() {
        let visibilityStatus = s2sStatus();
        setType("s2s", visibilityStatus);
      }

      function c2pStatus() {
        return c2pCheckBox.checked;
      }
      function p2pStatus() {
        return p2pCheckBox.checked;
      }
      function s2sStatus() {
        return s2sCheckBox.checked;
      }

      //ContinentalView: Enables/disables all realtionships of the specified type 
      //NationalView: Enables/disables relationships for the currently clicked country of the specified type
      function setType(relationshipType, visible) {
        visibilityStatus = (visible) ? "inherit" : "hidden";

        if (currentView.toLowerCase() == "continental") {
          g.selectAll(".ASN").selectAll(`g.${relationshipType}`).each(function (d) {
            d3.select(this).style("visibility", visibilityStatus);
          })
          // g.selectAll("asn").selectAll(`path.${relationshipType}`).style("visibility", visibilityStatus);
          // g.selectAll("asn").selectAll(`path.same-${relationshipType}`).style("visibility", visibilityStatus);
        }
        else if (currentView.toLowerCase() == "national") {
          // g.selectAll(".ASN").selectAll(`path.same-${relationshipType}`).style("visibility", function (currentASN) { return (currentASN.country == previousCountry && visible ? "visible" : "hidden") });
          g.select(`#${previousCountry}.country`).selectAll(".ASN").selectAll(`g.${relationshipType}`).each(function (d) {
            d3.select(this).style("visibility", visibilityStatus);
          })
        }

        else {
          let ixpC2pStatus = c2pStatus() ? "inherit" : "hidden";
          let ixpP2pStatus = p2pStatus() ? "inherit" : "hidden";
          let ixpS2sStatus = s2sStatus() ? "inherit" : "hidden";

          countryAsns.forEach(function (country) {
            g.select(`#${country}.country`).selectAll(".ASN").each(function (d, i) {
              let asnLevel = asnViewMap.get(d.id.toString());
              if (asnLevel <= level) {
                //remove found asn from list?
                d3.select(this).select("g.c2p").style("visibility", ixpC2pStatus);
                d3.select(this).select("g.p2p").style("visibility", ixpP2pStatus);
                d3.select(this).select("g.s2s").style("visibility", ixpS2sStatus);
              }
            })

          });

        }
      }




      function revertPreviousView() {
        if (currentView === "national") {
          revertToCountryInherit();
        }
        else if (currentView === "IXP") {
          revertToIXPInherit();
        }
      }

      //click IXP
      function clickIxp(d, i) {
        document.getElementById("radiobuttons").style.display = "none";
        document.getElementById("ixplevelcontrol").style.display = "initial";

        document.getElementById("allixpsandasns").checked = false;
        resetLevel();
        // revertPreviousView();
        // if (currentView == "national")
        // {
        //   revertToCountryInherit();
        // }
        if (currentView == "national") {
          revertToCountryInherit();
          let clickedIxp = d;
          previousIXP = d;


          asnViewMap = new Map();

          levelsMap = new Map();



          currentView = "IXP";



          showIxp(clickedIxp);
        }
        else if (currentView == "continental") {
          let clickedIxp = d;
          previousIXP = d;

          resetProcessed();


          asnViewMap = new Map();

          levelsMap = new Map();


          currentView = "IXP";

          showIxp(clickedIxp);
        }
        //otherwise the same IXP has been clicked





      }

      function levelOne(d) {
        // plots the ixp that was clicked, also gets the customer ASNs of that IXP


        // g.select(`#${d.country}.country`).selectAll(`#IXP_${d.id}`).each(
        //   function (d) {

        //     d3.select(this).style("visibility", "visible");
        //     customerAsns = d.customers;
        //   }
        // );
        //setting customer asns to levels map of key 1
        levelsMap.set("1", customerAsns);
        levelsMap.set("2", []);

        countryAsns = [];
        //Finding the country for each customer in the customerAsns list
        customerAsns.forEach(function (id) {
          countryAsns.push(asnsbyid.get(id).country);
          asnViewMap.set(id, "1");
        });
        //Removing duplicates
        countryAsns = [...new Set(countryAsns)];


        let ixpC2pStatus = c2pStatus() ? "inherit" : "hidden";
        let ixpP2pStatus = p2pStatus() ? "inherit" : "hidden";
        let ixpS2sStatus = s2sStatus() ? "inherit" : "hidden";


        countryAsns.forEach(function (country) {
          g.select(`#${country}.country`).selectAll(".ASN").each(function (d, i) {
            if (customerAsns.includes(d.id)) {
              //remove found asn from list?
              d3.select(this).style("visibility", "visible");

              d3.select(this).select("g.c2p").style("visibility", ixpC2pStatus);
              d3.select(this).select("g.p2p").style("visibility", ixpP2pStatus);
              d3.select(this).select("g.s2s").style("visibility", ixpS2sStatus);


              d3.select(this).selectAll("g").each(function (d) {
                currentGroup = d3.select(this);
                currentGroup.selectAll("line").each(function (d) {
                  let pathDestination = d3.select(this).attr("destination");
                  //Same level check
                  if (asnViewMap.get(pathDestination) == "1") {
                    //If the destination asn has been processed ignore the current path
                    if (asnsbyid.get(pathDestination).processed) {
                      d3.select(this).style("visibility", "hidden");
                    }
                    //otherwise the path stays as inherit (drawn)

                    //customer asns of level 1 remain as inherit
                  }
                  else if (asnViewMap.get(pathDestination) == "2") {
                    d3.select(this).style("visibility", "hidden");

                  }
                  else {
                    asnViewMap.set(pathDestination, "2");
                    levelsMap.get("2").push(pathDestination);
                    d3.select(this).style("visibility", "hidden");

                  }
                  // if (!customerAsns.includes(pathDestination)) {
                  //   d3.select(this).style("visibility", "hidden");
                  // }

                })

              })
              //Processed asn to avoid duplicates
              d.processed = true;

            }
          })



        })
        console.log(levelsMap.get("1").length);
        console.log(levelsMap.get("2").length);

        if (!levelsMap.get("1").length) {
          document.getElementById("increase").disabled = true;
          document.getElementById("increase").style.backgroundColor = "grey";

        }

      }

      //Function for levels greater than 1
      function levelsN(d, i) {
        let index = i;
        let nextIndex = index + 1;
        //index += "";

        //sets the map for the next layer
        if (levelsMap.get(nextIndex.toString()) == null) {
          levelsMap.set(nextIndex.toString(), []);
        }




        //Finding the country for each customer in the customerAsns list
        levelsMap.get(index.toString()).forEach(function (id) {
          countryAsns.push(asnsbyid.get(id).country);
        });

        //Removing duplicates
        countryAsns = [...new Set(countryAsns)];


        let ixpC2pStatus = c2pStatus() ? "inherit" : "hidden";
        let ixpP2pStatus = p2pStatus() ? "inherit" : "hidden";
        let ixpS2sStatus = s2sStatus() ? "inherit" : "hidden";


        countryAsns.forEach(function (country) {
          g.select(`#${country}.country`).selectAll(".ASN").each(function (d, i) {
            if (asnViewMap.get(d.id) == index.toString()) {
              //remove found asn from list?
              d3.select(this).style("visibility", "visible");

              d3.select(this).select("g.c2p").style("visibility", ixpC2pStatus);
              d3.select(this).select("g.p2p").style("visibility", ixpP2pStatus);
              d3.select(this).select("g.s2s").style("visibility", ixpS2sStatus);


              d3.select(this).selectAll("g").each(function (d) {
                currentGroup = d3.select(this);
                currentGroup.selectAll("line").each(function (d) {
                  let pathDestination = d3.select(this).attr("destination");
                  if (asnViewMap.get(pathDestination) == index.toString()) {
                    //customer asns of level 1 remain as inherit
                    if (asnsbyid.get(pathDestination).processed) {
                      d3.select(this).style("visibility", "hidden");

                    }
                    //Otherwise path is drawn
                  }
                  //Have come across this element in layer below before
                  else if (asnViewMap.get(pathDestination) == nextIndex.toString()) {
                    d3.select(this).style("visibility", "hidden");

                  }

                  else if (asnViewMap.get(pathDestination) < index.toString()) {
                    //Do nothing (draw the path by default)
                  }

                  //Destination in next layer but no yet registered in the map
                  else {

                    asnViewMap.set(pathDestination, nextIndex.toString());
                    levelsMap.get(nextIndex.toString()).push(pathDestination);
                    d3.select(this).style("visibility", "hidden");
                  }


                })

              })

              d.processed = true;

            }

          })



        })

        if (!levelsMap.get(nextIndex.toString()).length) {
          document.getElementById("increase").disabled = true;
          document.getElementById("increase").style.backgroundColor = "grey";

        }
        //console.log(levelsMap);

      }

      function showIxp(d) {
        //Sets everything on the map to hidden
        g.selectAll(".country").style("visibility", "hidden");
        g.select(`#${d.country}.country`).selectAll(`#IXP_${d.id}`).each(
          function (d) {

            d3.select(this).style("visibility", "visible");
            customerAsns = d.customers;
          }
        );
        if (d.customers.length) {
          //LEVEL 1:
          levelOne(d);

          //LEVEL >=1
          //console.log(level);
          for (let i = 2; i <= level; i++) {

            levelsN(d, i);
          }

        }
        else {
          document.getElementById("increase").disabled = true;
          document.getElementById("increase").style.backgroundColor = "grey";
        }

      }


      //change tect box on country hover
      function hoverCountry(d, i) {
        let cCode = " Country Name : " + d.properties.name + ", " + d.properties.country_code;
        let noOfIXPs = " Number of IXPs : " + g.select(`.country#${d.properties.country_code}`).selectAll(`polygon`).size();
        let noOfASNs = " Number of ASNs : " + g.select(`.country#${d.properties.country_code}`).selectAll(`g.ASN`).size();
        document.getElementById("cCodeHTML").textContent = cCode;
        document.getElementById("noOfIXPsHTML").textContent = noOfIXPs;
        document.getElementById("noOfASNsHTML").textContent = noOfASNs;

        document.getElementById("ixpIdHTML").textContent = "";
        document.getElementById("ixpNameHTML").textContent = "";
        document.getElementById("ixpCountryHTML").textContent = "";
        document.getElementById("ixpCustomersHTML").textContent = "";

        document.getElementById("asnIdHTML").textContent = "";
        document.getElementById("asnCountryHTML").textContent = "";
        document.getElementById("asnCustomersHTML").textContent = "";

      }

      //change tect box on IXP hover
      function hoverIXP(d, i) {
        let ixpIdHTML = " IXP ID : " + d.id;
        let ixpNameHTML = " IXP Name :  " + d.name;
        let ixpCountryHTML = " Country : " + d.country;
        let ixpCustomersHTML = " Direct Customers : " + d.customers.length;
        document.getElementById("ixpIdHTML").textContent = ixpIdHTML;
        document.getElementById("ixpNameHTML").textContent = ixpNameHTML;
        document.getElementById("ixpCountryHTML").textContent = ixpCountryHTML;
        document.getElementById("ixpCustomersHTML").textContent = ixpCustomersHTML;

        document.getElementById("asnIdHTML").textContent = "";
        document.getElementById("asnCountryHTML").textContent = "";
        document.getElementById("asnCustomersHTML").textContent = "";

        document.getElementById("cCodeHTML").textContent = "";
        document.getElementById("noOfIXPsHTML").textContent = "";
        document.getElementById("noOfASNsHTML").textContent = "";

      }

      //change tect box on IXP hover
      function hoverASN(d, i) {
        //console.log(d);
        let asnIdHTML = " ASN ID : " + d.id;
        let asnCountryHTML = " Country Name :  " + d.country;
        let asnCustomerHTML = " Customers : ";
        for (let [key, value] of d.map) {
          asnCustomerHTML = asnCustomerHTML + value + " : " + key + ", ";
        }
        document.getElementById("asnIdHTML").textContent = asnIdHTML;
        document.getElementById("asnCountryHTML").textContent = asnCountryHTML;
        document.getElementById("asnCustomersHTML").textContent = asnCustomerHTML;

        document.getElementById("cCodeHTML").textContent = "";
        document.getElementById("noOfIXPsHTML").textContent = "";
        document.getElementById("noOfASNsHTML").textContent = "";

        document.getElementById("ixpIdHTML").textContent = "";
        document.getElementById("ixpNameHTML").textContent = "";
        document.getElementById("ixpCountryHTML").textContent = "";
        document.getElementById("ixpCustomersHTML").textContent = "";



      }


      //Changes state variables and makes a call to the eventhandler by passing in the currently clicked country
      function clickCountry(d, i) {
        document.getElementById("ixplevelcontrol").style.display = "none";
        document.getElementById("radiobuttons").style.display = "initial";
        resetLevel();



        //clickToZoom(ZOOM_COUNTRY_CLICK);
        var bounds = path.bounds(d),
          dx = bounds[1][0] - bounds[0][0],
          dy = bounds[1][1] - bounds[0][1],
          x = (bounds[0][0] + bounds[1][0]) / 2,
          y = (bounds[0][1] + bounds[1][1]) / 2,
          scale = Math.max(1, Math.min(5, 0.9 / Math.max(dx / width, dy / height))),
          translate = [width / 2.5 - scale * x, height / 2.25 - scale * y];

        svg.transition()
          .duration(750)
          // .call(zoom.translate(translate).scale(scale).event); // not in d3 v4
          .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)); // updated for d3 v4        // if (d && centered !== d) {
        //   var centroid = path.centroid(d);
        //   console.log(centroid);
        //   x = centroid[0];
        //   y = centroid[1];
        //   k = 2.5;
        //   centered = d;
        // }

        // zooming();

        document.getElementById("allixpsandasns").checked = false;

        if (currentView == "national") {
          revertToCountryInherit();
        }
        else if (currentView == "IXP") {
          revertToIXPInherit();
        }
        else {
          resetProcessed();
          document.getElementById("radioone").checked = true;

        }



        let clickedCountry = d.properties.country_code;
        previousCountry = d.properties.country_code;

        currentView = "national";

        // drawEverything(true);

        showCountry(clickedCountry);

      }

      function resetProcessed() {

        asnsbyid.each(function (asn) {
          asn.processed = false;
        })

      }


      //this function is called either when zoom buttons are pressed or when a country is clicked
      function zooming() {
        g
          .transition()
          .duration(750) // To prevent stroke width from scaling
          .attr('transform', "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
          .style("stroke-width", 1.5 / k + "px");

      }


      //Ensures that only ASN's & IXP's and it's internal relationships are displayed by using a passed in country reference
      function showCountry(country) {

        //g.selectAll(".country").selectAll("path").style("visibility", "hidden");

        // read checkboxes -> ternary operator -> boolean -> visible/hidden -> group container
        g.selectAll(".country").style("visibility", function (value) { return value.properties.country_code == country ? "visible" : "hidden" })



        showAllCountry(country);
      }


      //function called when show all is clicked when in  contry mode
      function showAllCountry(country) {
        let countryC2pStatus = c2pStatus() ? "inherit" : "hidden";
        let countryP2pStatus = p2pStatus() ? "inherit" : "hidden";
        let countryS2sStatus = s2sStatus() ? "inherit" : "hidden";
        g.select(`#${country}.country`).selectAll(".ASN").each(function (d) {
          let currentAsN = d;
          if (d.CountryLevel <= level) {
            d3.select(this).style("visibility", "inherit");



            d3.select(this).select("circle").attr("fill", countryFill).style("stroke", countryFill).attr("r", 1);
            currentAsn = d3.select(this).selectAll("g").each(function (d) {
              currentGroup = d3.select(this);
              currentGroup.selectAll("line").style("visibility", function (d) {

                let destinationAsn = asnsbyid.get(d3.select(this).attr("destination"));
                //Country check
                if (destinationAsn.country == country) {
                  //Destination in layer below must be hidden
                  if (destinationAsn.CountryLevel > currentAsN.CountryLevel) {
                    return "hidden";
                  }
                  //Destination in same layer requires to check if destination has been processed before
                  else if (destinationAsn.CountryLevel == currentAsN.CountryLevel) {
                    return destinationAsn.processed ? "hidden" : "inherit";
                  }
                  //Destination in layer above must be drawn
                  else {
                    return "inherit";
                  }
                }

                else {
                  return "hidden";
                }



              })

              if (currentGroup.attr("class") == "c2p") {
                currentGroup.style("visibility", countryC2pStatus);
              }
              else if (currentGroup.attr("class") == "p2p") {
                currentGroup.style("visibility", countryP2pStatus);
              }
              else {
                currentGroup.style("visibility", countryS2sStatus);
              }
            }) // end for every relationship container
            asnsbyid.get(d.id).processed = true;

          } // if in the current country level
          else {
            d3.select(this).style("visibility", "hidden");
          }


        })
      }

      function revertToCountryInherit() {
        document.getElementById("radioone").checked = true;

        g.select(`#${previousCountry}.country`).selectAll(".ASN").style("visibility", "inherit").each(function (d) {
          let cASN = d3.select(this);
          cASN.select("circle").style("fill", continentalFill).attr("r", 1.5);
          cASN.selectAll("g").style("visibility", "inherit").selectAll("line").style("visibility", "inherit");
          cASN.processed = false;
        })
      }

      function revertToIXPInherit() {


        g.select(`#${previousIXP.country}.country`).selectAll(`#IXP_${previousIXP.id}`).each(function (d) {
          d3.select(this).style("visibility", "inherit");
        });

        countryAsns.forEach(function (country) {
          g.select(`#${country}.country`).selectAll(".ASN").each(function (d, i) {


            if (asnViewMap.get(d.id) != null) {

              //remove found asn from list?
              d3.select(this).style("visibility", "inherit")
                .selectAll("g").style("visibility", "inherit")
                .selectAll("line").style("visibility", "inherit");

              asnsbyid.get(d.id).processed = false;
            }
          })


        })

      }

      //true: draws all elements on the map
      //false: removes all elements on the map
      function drawEverything(showFlag) {

        showFlag = showFlag ? "visible" : "hidden";

        if (showFlag === "hidden") {
          g.selectAll(".country").style("visibility", showFlag);
        }
        else {


          let countryC2pStatus = c2pStatus() ? "inherit" : "hidden";
          let countryP2pStatus = p2pStatus() ? "inherit" : "hidden";
          let countryS2sStatus = s2sStatus() ? "inherit" : "hidden";

          g.selectAll(".country").each(function (d) {

            let cCountry = d3.select(this);
            cCountry.style("visibility", showFlag);
            //console.log(cCountry);
            cCountry.selectAll(".ASN").each(function (d) {
              let currentAsN = d;
              if (d.AfricaLevel <= level) {
                d3.select(this).style("visibility", "inherit");
                d3.select(this).select("circle").style("fill", continentalFill).style("stroke", continentalFill).attr("r", 1);
                currentAsn = d3.select(this).selectAll("g").each(function (d) {
                  currentGroup = d3.select(this);
                  currentGroup.selectAll("line").style("visibility", function (d) {


                    let destinationAsn = asnsbyid.get(d3.select(this).attr("destination"));

                    // return ((destinationAsn.country == country) && (destinationAsn.CountryLevel <= level)) ? "inherit" : "hidden";


                    //Destination in layer below must be hidden
                    if (destinationAsn.CountryLevel > currentAsN.CountryLevel) {
                      return "hidden";
                    }
                    //Destination in same layer requires to check if destination has been processed before
                    else if (destinationAsn.CountryLevel == currentAsN.CountryLevel) {
                      return destinationAsn.processed ? "hidden" : "inherit";
                    }
                    //Destination in layer above must be drawn
                    else {
                      return "inherit";
                    }




                  })

                  if (currentGroup.attr("class") == "c2p") {
                    currentGroup.style("visibility", countryC2pStatus);
                  }
                  else if (currentGroup.attr("class") == "p2p") {
                    currentGroup.style("visibility", countryP2pStatus);
                  }
                  else {
                    currentGroup.style("visibility", countryS2sStatus);
                  }


                })

                currentAsN.processed = true;
              }


              else {
                d3.select(this).style("visibility", "hidden");
              }


            })
            // d3.select(this).selectAll(".ASN").each(function (d) {
            //   if (d.AfricaLevel <= level) {
            //     d3.select(this).style("visibility", "inherit");
            //     currentAsn = d3.select(this);

            //     currentAsn.select("g.c2p").style("visibility", countryC2pStatus);
            //     currentAsn.select("g.p2p").style("visibility", countryP2pStatus);
            //     currentAsn.select("g.s2s").style("visibility", countryS2sStatus);


            //   }

            // })
          })


        }

      }

      function conesLevel(d) {
        level = d;
        if (currentView == "national") {

          showCountry(previousCountry);
        }
        else if (currentView == "continental") {
          drawEverything(true);
        }

      }
      function levelClick(l) {
        previousLevel = level;
        level = +l;
        leveltest = " Level " + level;
        //document.getElementById("levelhtml").textContent = leveltest;

        if (currentView == "IXP") {
          //going up only
          if (previousLevel < level) {
            for (let i = (previousLevel + 1); i <= level; i++) {
              levelsN(previousIXP, i);

            }
          }
          else {

            countryAsns.forEach(function (country) {
              g.select(`#${country}.country`).selectAll(".ASN").each(function (d, i) {
                asnLevel = +asnViewMap.get(d.id.toString());
                if (asnLevel > level && asnLevel <= previousLevel) {
                  d3.select(this).style("visibility", "inherit");
                  d3.select(this).selectAll("line").style("visibility", "inherit");
                }
              })
            })
          }
        }
        // else if (currentView = "national") {


        //     document.getElementById("increase").disabled = level==4;
        //     document.getElementById("increase").style.backgroundColor = level==4?"grey":"black";
        //     document.getElementById("decrease").disabled = level==1;
        //     document.getElementById("decrease").style.backgroundColor = level==1?"grey":"black";

        //   showCountry(previousCountry);
        // }


      }

      //zoom in and out buttons
      function clickToZoom(zoomStep) {
        svg.transition().duration(ZOOM_DURATION).call(zoom.scaleBy, zoomStep)
      }
      //Reset map zoom
      function reset() {


        svg.transition()
          .duration(750)
          // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
          .call(zoom.transform, d3.zoomIdentity); // updated for d3 v4
      }

      //Triggered during panning.
      // the scale vaalue will be kept the same, while the translate will change depending on the mouse drag
      function zoomed() {
        //d3.event.transform.k = k;
        //console.log(d3.event.transform);

        g// To prevent stroke width from scaling
          .attr("transform", d3.event.transform);

        // g
        //   .selectAll("g.country") // To prevent stroke width from scaling
        //   .attr("transform", d3.event.transform);


      }
      // function zoomed() {
      //   g.select("g").selectAll("path")
      //   .style("stroke-width", 1.5 / d3.event.transform.k + "px")
      //   // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
      //   .attr("transform", d3.event.transform); // updated for d3 v4


      //   g.selectAll("polygon")
      //   .style("transform", "translate(scale(" + 1.5 /d3.event.transform.k+ "))")
      //   //.style("stroke-width", 1.5 / d3.event.transform.k + "px");
      //   // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
      //   .attr("transform", d3.event.transform); // updated for d3 v4

      //   g.selectAll("circle")
      //   .style("transform", "translate(scale(" + 1.5 /d3.event.transform.k+ "))")
      //   //.style("stroke-width", 1.5 / d3.event.transform.k + "px");
      //   // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
      //   .attr("transform", d3.event.transform); // updated for d3 v4
      // }

      function decreaseLevel() {
        let c = document.getElementById("levelsText").innerHTML;
        if (c >= 2) {
          if (c == 2) {

            document.getElementById("decrease").disabled = true;
            document.getElementById("decrease").style.backgroundColor = "grey";

          }
          c = (+c) - 1;
        }



        document.getElementById("increase").disabled = false;
        document.getElementById("increase").style.backgroundColor = "black";


        document.getElementById("levelsText").textContent = c + "";
        levelClick(c);


      }
      function increaseLevel() {
        let c = document.getElementById("levelsText").innerHTML;
        c = (+c) + 1;
        document.getElementById("levelsText").textContent = c + "";

        document.getElementById("decrease").disabled = false;
        document.getElementById("decrease").style.backgroundColor = "black";

        levelClick(c);

      }
      function resetLevel() {

        level = 1;
        previousLevel = null;

        document.getElementById("levelsText").textContent = "1";

        document.getElementById("increase").disabled = false;
        document.getElementById("increase").style.backgroundColor = "black";

        document.getElementById("decrease").disabled = true;
        document.getElementById("decrease").style.backgroundColor = "grey";

      }


      //Modifies the IXP element so that it may be drawn on screen
      function typeIxp(arr) {
        for (let index = 0; index < arr.length; index++) {
          let d = arr[index];


          // d[0] = +d.longitude;
          // d[1] = +d.latitude;

          if (d.customers) {
            d.customers = d.customers.split(",");
          }
          else {
            d.customers = [];
          }
          arr[index] = d;
        }
        return arr;
      }
      //Modifies the ASN element by converting attributes to numbers and by adding list attributes that contain the relationships that an asn has with other asns
      function typeAsn(arr) {
        for (let index = 0; index < arr.length; index++) {
          let d = arr[index];


          // d[0] = +d.longitude;
          // d[1] = +d.latitude;

          d.longitude = +d.longitude;
          d.latitude = +d.latitude;


          d.processed = false;

          // d.map = JSON.parse(d.map);


          if (d.map) {
            let kv_pairs = d.map.split(" ");
            //Can be improved maybe hopefully
            d.map = new Map();



            kv_pairs.forEach(function (pair) {
              split_pairs = pair.split(":");
              d.map.set(split_pairs[0], split_pairs[1]);
            })
          }
          else {
            d.map = new Map();
          }
          arr[index] = d;
        }
        return arr;
      }


      function dropdown() {
        

        var select = document.getElementById("selectNumber");
        // <a href="#" class="w3-bar-item w3-button">Link 1</a>
        let datesDrop=dateList["dates"];
        console.log(datesDrop);
        for (let i = 0; i < datesDrop.length; i++) {
          let year = datesDrop[i];
          let el=document.createElement("option");
          el.textContent=year;
          el.value=year;
          select.appendChild(el);
          
        }
        
      }

      d3.select(self.frameElement).style("height", height + "px");

    </script>

  </div>