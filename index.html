<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">


<!--Styling of elements on map-->
<style>
  .country-area {
    fill: black;
    stroke: #fff;
  }

  /*.countries*/
  .country-area:hover {
    fill: #cccccc;
  }

  .customer {
    stroke: green;
    fill: none;
  }

  .same-customer {
    stroke: green;
    fill: none;
  }

  .peer {
    stroke: red;
    fill: none;
  }

  .same-peer {
    stroke: red;
    fill: none;
  }

  .sibling {
    stroke: turquoise;
    fill: none;
  }

  .same-sibling {
    stroke: turquoise;
    fill: none;
  }

  .asn-container:hover {
    stroke: blue;
  }

  .IXP {
    fill: rgba(169, 103, 201, 0.7);

  }

  .asn-dots {
    fill: rgb(255, 255, 0, 0.7);

  }
</style>
<!--Burger Menu and filters-->

<body style="background-color: 	#cae7f9;">
  <div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left" style="display:none; background-color: white;"
    id="mySidebar">
    <div style="background-color: black; color:white;">
      <button class="w3-button w3-xlarge w3-hover-black w3-bar-item" onclick=" w3_close()">&times;
        <h3 style=" display: inline-block; ">Africa Internet Visualizer</h3></button>
    </div>
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="cbborder" name="vehicle1" checked="checked"> <label
          for="vehicle1">Borders</label><br>

        </label></input>
      </div>
    </a>
    <a class="w3-bar-item">Views</a>

    <!-- Continental View checkbox -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="allixpsandasns" onclick="allixpsandasnscb()" checked="checked">
        <label>Continental View
        </label><br>

        </label></input>
      </div>

    </a>


    <a class="w3-bar-item">Relationships</a>

    <!-- Peer to peer cb -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="p2pcb" onclick="peerToPeer()" checked="checked"> <label>Peer to Peer
        </label><br>

        </label></input>
      </div>

    </a>
    <!-- customer to provider relationship -->
    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="c2pcb" onclick="customerToProvider()" checked="checked"> <label>Customer to provider
        </label><br>

        </label></input>
      </div>

    </a>
    <!-- sibling to sibling relationship -->

    <a href="#" class="w3-bar-item w3-button item">
      <div> <input type="checkbox" id="s2scb" onclick="siblingToSibling()" checked="checked"> <label>Sibling to Sibling
        </label><br>

        </label></input>
      </div>

    </a>



    <!-- <a href="#" class="w3-bar-item w3-button">Link 2</a>
    <a href="#" class="w3-bar-item w3-button">Link 3</a> -->
  </div>
  <div style="background-color: black;">
    <button id="openNav" class="w3-button w3-xlarge w3-hover-black w3-bar-item"
      style="background-color: black; color: white;" onclick="w3_open()">&#9776; <h2 style=" display: inline-block;">
        Africa Internet Visualizer</h1>
    </button>

  </div>
  <div id="main">

    <script>
      function w3_open() {
        document.getElementById("main").style.marginLeft = "25%";
        document.getElementById("mySidebar").style.width = "25%";
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("openNav").style.display = 'none';
      }
      function w3_close() {
        document.getElementById("main").style.marginLeft = "0%";
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("openNav").style.display = "inline-block";
      }
      document.getElementById("cbborder").onclick = function () {
        if (this.checked) {
          var cols = document.getElementsByClassName(/*'countries'*/'country');
          
          for (i = 0; i < cols.length; i++) {
            cols[i].style.stroke = 'white';

          }


        }
        else {
          var cols = document.getElementsByClassName(/*'countries'*/'country');
          for (i = 0; i < cols.length; i++) {
            cols[i].style.stroke = 'black';

          }

        }
      };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <!--D3 work starts here-->
    <script>

      //Canvas settings
      var width = 1200, height = 800;

      //Projection type
      var projection = d3.geoMercator()
        .translate([width / 2, height / 2])
        .scale(500);

      //Path generator
      var path = d3.geoPath()
        .projection(projection);

      //ASN projection
      var pathTwo = d3.geoPath()
        .projection(projection)
        .pointRadius(5);
      //Add canvas with settings for its height and width, store the reference here in svg
      var svg = d3.select("#main").append("svg")
        .attr("width", width)
        .attr("height", height);

      //Methods used to know what filtering methods must be applied
      var currentView;
      var currentViewedCountry;

      
      var p2pCheckBox = document.getElementById("p2pcb");

      var c2pCheckBox = document.getElementById("c2pcb");

      var s2sCheckBox = document.getElementById("s2scb");
      //Load data... Should we split this up into callable methods?
      d3.queue()
        .defer(d3.json, "testTopoAfrica.json")
        .defer(d3.csv, "ixps.csv", typeIxp)
        .defer(d3.csv, "asns.csv", typeAsn)
        .defer(d3.csv, "links.csv")
        .await(ready);

      //Load data: Alternative
      // d3.queue()
      //   .defer(d3.json, "http://192.168.0.18:8080/testTopoAfrica.json")
      //   .defer(d3.csv, "http://192.168.0.18:8080/ixps.csv", typeIxp)
      //   .defer(d3.csv, "http://192.168.0.18:8080/asns.csv", typeAsn)
      //   .defer(d3.csv, "http://192.168.0.18:8080/links.csv")

      //   .await(ready);


      //Callback after data is loaded
      function ready(error, africa, ixps, asns, links) {

        if (error) throw error;
        //Set id fields as the key for the ixp and asn datasets
        var ixpsbyid = d3.map(ixps, function (d) { return d.id; });
        var asnsbyid = d3.map(asns, function (d) { return d.id; });



        //add each link to an asn
        links.forEach(function (link) {
          //get source/target asns from an id field 
          var source = asnsbyid.get(link.origin)
          var target = asnsbyid.get(link.destination);
          //add link type to asn
          if (link.type == "c2p") {
            if (source.country != target.country) {
              source.customer_peer.coordinates.push([source, target]);
              target.customer_peer.coordinates.push([target, source]);
            }
            else {
              source.same_customer_peer.coordinates.push([source, target]);
              target.same_customer_peer.coordinates.push([target, source]);
            }
          }

          else if (link.type == "p2p") {
            if (source.country != target.country) {
              source.peer_peer.coordinates.push([source, target]);
              target.peer_peer.coordinates.push([target, source]);
            }
            else {
              source.same_peer_peer.coordinates.push([source, target]);
              target.same_peer_peer.coordinates.push([target, source]);
            }
          }
          else {
            if (source.country != target.country) {
              source.sibling_sibling.coordinates.push([source, target]);
              target.sibling_sibling.coordinates.push([target, source]);
            }
            else {
              source.same_sibling_sibling.coordinates.push([source, target]);
              target.same_sibling_sibling.coordinates.push([target, source]);
            }
          }
        });

        var features = topojson.feature(africa, africa.objects.testAfrica).features;

        //Add drawing-box that will contain all country drawings
        var drawingBox = svg.append("g")
          .attr("class", "drawing-box")

        //Draw countries inside the drawing box using the geoJson features
        drawingBox.selectAll(null) //null is used since no country-area element has been created before
          .data(features)
          .enter()
          .append("path")
          .attr("class", "country-area")
          .attr("d", path)
          .on("click", clickCountry);

        //Add empty country-containers that will contain asn and ixp elements
        var countries = svg.selectAll(null) //null is used since no country containers have been defined before (no search time -> more efficient )
          .data(features)
          .enter().append("g")
          .attr("class", "country-container")
          .attr("id", function (currentFeature) { return currentFeature.properties.country_code });
        /*.attr("class", "country")*/  //ask about this line... no class being added to anything? or is it because of ln 239?


        // Add IXP elements to each country container
        countries
          .each(
            function (currentFeature, i) {

              //d3.select(this) ->  Country-container element
              var currentCountry = d3.select(this);

              //Append IXP circles located in the current country
              currentCountry.selectAll("circle")
                .data(ixps.filter(function (currentIxp) { return currentIxp.country == currentCountry.attr("id") }))
                .enter()
                .append("circle")
                .attr("class", "IXP")
                .attr("id", function (currentIxp) { return currentIxp.id })
                .attr("cx", function (currentIxp) { return projection([currentIxp.longitude, currentIxp.latitude])[0] })
                .attr("cy", function (currentIxp) { return projection([currentIxp.longitude, currentIxp.latitude])[1] })
                .style("fill", "rgba(169, 103, 201, 0.7)")
                .attr("r", 8);
            });

        /* HOW TO FILTER A SELECTION
        svg.selectAll(".country").filter(function(d,i){
          return d3.select(this).attr("id")=="Algeria";
        }).append("circle").attr("cx", 1).attr("cy", 1);
        */

        /*
        HOW TO ADD AN ELEMENT TO EACH THING IN A SELECTION
        svg.selectAll(".country").each(function(d,i){
          d3.select(this).append("circle").attr("cx", 1).attr("cy", 1);
        });
        */

        svg.selectAll("asn-dots")
          .data(asns)
          .enter()
          .append("circle")
          .attr("class", function (d) { return `${d.country} asn-dots` })
          .attr("cx", function (d) { return projection([d.longitude, d.latitude])[0] })
          .attr("cy", function (d) { return projection([d.longitude, d.latitude])[1] })
          .style("fill", "rgb(255,255,0,0.7)")
          .attr("r", 4);

        //Create asn-containers that will contain the asn links
        var asnContainers = svg.selectAll(".asn-container")
          .data(asns)
          .enter().append("g")
          .attr("class", function (d) { return `${d.country} asn-container` });


        //Add the asn relationships to each asn

        //customer-peer
        asnContainers.append("path")
          .attr("class", "customer")
          .attr("d", function (d) { return path(d.customer_peer); });

        asnContainers.append("path")
          .attr("class", "same-customer")
          .attr("d", function (d) { return path(d.same_customer_peer); });
        //peeer_peer
        asnContainers.append("path")
          .attr("class", "peer")
          .attr("d", function (d) { return path(d.peer_peer); });

        asnContainers.append("path")
          .attr("class", "same-peer")
          .attr("d", function (d) { return path(d.same_peer_peer); });

        //sibling_sibling
        asnContainers.append("path")
          .attr("class", "sibling")
          .attr("d", function (d) { return path(d.sibling_sibling); });

        asnContainers.append("path")
          .attr("class", "same-sibling")
          .attr("d", function (d) { return path(d.same_sibling_sibling); });
        //End for adding asn relationships

        currentView = "continental"




      }; //end of reading files

      // All IXPs and ASNs checkbox
      function allixpsandasnscb() {

        
        currentView = "continental";
        
        var allixpsandasns = document.getElementById("allixpsandasns");

        if (allixpsandasns.checked == true) {
          drawEverything(true);

          


        } else {
          drawEverything(false); //remove everything
        }

      }


      // Check box for Peer to peer
      function peerToPeer() {
        var visibilityStatus = document.getElementById("p2pcb").checked;
        setType("peer",visibilityStatus);
      }

      // Check box for Customer to provider
      function customerToProvider() {
        var visibilityStatus = document.getElementById("c2pcb").checked;
        setType("customer",visibilityStatus);
      }
      // Check box for sibling to sibling
      function siblingToSibling() {
        var visibilityStatus = document.getElementById("s2scb").checked;
        setType("sibling",visibilityStatus);
      }

      function setType(relationshipType, visible)
      {
          visibilityStatus = (visible) ? "visible" : "hidden";

          if (currentView.toLowerCase() == "continental")
          {
          svg.selectAll("g.asn-container").selectAll(`path.${relationshipType}`).style("visibility", visibilityStatus);
          svg.selectAll("g.asn-container").selectAll(`path.same-${relationshipType}`).style("visibility", visibilityStatus);
          }
          else if(currentView.toLowerCase() == "national")
          {
            svg.selectAll("g.asn-container").selectAll(`path.same-${relationshipType}`).style("visibility", function(currentASN){ return (currentASN.country == currentViewedCountry && visible ? "visible" : "hidden")});
            
          }
          
      }


      function clickCountry(d, i) {
        document.getElementById("allixpsandasns").checked = false;

        
        var clickedCountry = d.properties.country_code;
        currentViewedCountry = d.properties.country_code;

        currentView = "national";

        // drawEverything(true);

        showCountry(clickedCountry);

      }

      function showCountry(country) {

        // svg.selectAll(".IXP").filter(function (value, index) { return value.country != country }).style("visibility", option);
        svg.selectAll(".IXP").style("visibility", function (value) {return (value.country == country ? "visible":"hidden")});

        svg.selectAll("circle.asn-dots").style("visibility", function(value){return (value.country == country ? "visible":"hidden")});
        
        svg.selectAll("g.asn-container").selectAll("path.customer").style("visibility", "hidden");
        svg.selectAll("g.asn-container").selectAll("path.peer").style("visibility", "hidden");
        svg.selectAll("g.asn-container").selectAll("path.sibling").style("visibility", "hidden");

        svg.selectAll("g.asn-container").selectAll("path.same-customer").style("visibility", function(currentASN){ return ((currentASN.country == country && c2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.same-peer").style("visibility", function(currentASN){ return ((currentASN.country == country && p2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.same-sibling").style("visibility", function(currentASN){ return ((currentASN.country == country && s2sCheckBox.checked ? "visible" : "hidden")) });

        // svg.selectAll("g.asn-container").filter(function (value, index) { return value.country != country }).style("visibility", option);

      }
      //true: draws all elements on the map
      //false: removes all elements on the map
      function drawEverything(showEverything) {

        var visibilityStatus = showEverything ? "visible" : "hidden";

        svg.selectAll(".IXP").style("visibility", visibilityStatus);

        svg.selectAll("circle.asn-dots").style("visibility", visibilityStatus);

        svg.selectAll("g.asn-container").selectAll("path.customer").style("visibility",function(currentASN){ return (( showEverything && c2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.peer").style("visibility",function(currentASN){ return (( showEverything && p2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.sibling").style("visibility", function(currentASN){ return (( showEverything && s2sCheckBox.checked ? "visible" : "hidden")) });


        
        svg.selectAll("g.asn-container").selectAll("path.same-customer").style("visibility",function(currentASN){ return (( showEverything && c2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.same-peer").style("visibility",function(currentASN){ return (( showEverything && p2pCheckBox.checked ? "visible" : "hidden")) });
        svg.selectAll("g.asn-container").selectAll("path.same-sibling").style("visibility", function(currentASN){ return (( showEverything && s2sCheckBox.checked ? "visible" : "hidden")) });

        // svg.selectAll(".IXP").style("visibility", visibilityStatus);
        // svg.selectAll("circle.asn-dots").style("visibility", visibilityStatus);

        // svg.selectAll("customer").style("visibility", visibilityStatus);
        // svg.selectAll("peer").style("visibility", visibilityStatus);
        // svg.selectAll("sibling").style("visibility", visibilityStatus);

        // svg.selectAll("g.asn-container").selectAll("path.customer").style("visibility", visibilityStatus);
        // svg.selectAll("g.asn-container").selectAll("path.peer").style("visibility", visibilityStatus);
        // svg.selectAll("g.asn-container").selectAll("path.sibling").style("visibility", visibilityStatus);

        // svg.selectAll("g.asn-container").style("visibility", visibilityStatus);

      }


      function typeIxp(d) {
        d[0] = +d.longitude;
        d[1] = +d.latitude;
        d.arcs = { type: "MultiLineString", coordinates: [] };

        return d;
      }
      function typeAsn(d) {

        d[0] = +d.longitude;
        d[1] = +d.latitude;

        //Add relationship arrays to each asn
        d.customer_peer = { type: "MultiLineString", coordinates: [] };
        d.same_customer_peer = { type: "MultiLineString", coordinates: [] };

        d.peer_peer = { type: "MultiLineString", coordinates: [] };
        d.same_peer_peer = { type: "MultiLineString", coordinates: [] };

        d.sibling_sibling = { type: "MultiLineString", coordinates: [] };
        d.same_sibling_sibling = { type: "MultiLineString", coordinates: [] };



        return d;
      }
      d3.select(self.frameElement).style("height", height + "px");

    </script>